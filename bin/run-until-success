#!/usr/bin/env bash

# Usage: run-until-success COMMAND [PARAMETERS...]
#
# Run a command repeatedly until it exits with status code 0.

# Get the command and parameters.
COMMAND=("$@")

# Check if the command exists.
if ! command -v "${COMMAND[0]}" > /dev/null 2>&1; then
    printf >&2 "Error: Command '%s' not found.\n" "${COMMAND[0]}"
    exit 2
fi

# Print the command and each argument with bold text.
printf "Command: $(tput bold)%s$(tput sgr0) " "${COMMAND[0]}"
for arg in "${COMMAND[@]:1}"; do
    printf "'$(tput bold)%s$(tput sgr0)' " "$arg"
done
printf "\n"

# Retry loop until the command exits with status code 0.
while true; do
    # Run the command.
    "${COMMAND[@]}"
    exit_code=$?

    if [ $exit_code -eq 0 ]; then
        printf "$(tput setaf 2)Command succeeded with exit code 0.$(tput sgr0)\n"
        break
    else
        printf "$(tput setaf 1)Command failed with exit code %d. Retrying...$(tput sgr0)\n" $exit_code
        # Wait before retrying.
        sleep 2
    fi
done
